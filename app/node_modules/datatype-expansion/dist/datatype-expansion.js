var expansion=function(e){"use strict";function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r=require("lodash"),u=require("./util").isOpaqueType;function p(t,n,i,o){if("string"==typeof t)try{JSON.parse(t),t={type:"json",content:t}}catch(e){}if("string"==typeof t){if(/^\(.+\)$/.test(t)&&(t=t.match(/^\((.+)\)$/)[1]),u(t)||"object"===t||"array"===t)return{type:t};if(t.endsWith("?")&&u(t.replace("?","")))return s({type:"union",anyOf:[{type:t.replace("?","")},{type:"nil"}]},n,i,o);if(t.endsWith("[]"))return{type:"array",items:p(t.match(/^(.+)\[]$/)[1],n,i,o)};if(/^[^|\s]+(?:\|[^|\s]+)+$/.test(t.replace(/\s+/g,"")))return s({anyOf:t.split("|").map(function(e){return e.trim()}),type:"union"},n,i,o);if(t in n){if(t in i)return{type:"$recur"};i=Object.assign(function(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}({},t,!0),i);var e=n[t];return o.trackOriginalType&&"object"!==a(e)&&(e={type:e}),e=p(e,n,i,o),o.trackOriginalType&&(e.originalType=t),e}throw new Error("could not resolve: "+t)}if("object"!==a(t))throw new Error("form can only be a string or an object");if(t=r.cloneDeep(t),Array.isArray(t)&&(t={type:t}),t.type=t.type||t.properties&&"object"||t.items&&"array"||o.topLevel||"any","string"==typeof t.type){if("array"===t.type)return y(t,n,i,o);if("object"===t.type)return f(t,n,i,o);if("union"===t.type)return s(t,n,i,o);t.type in n?(t=c(t,n,i,o)).type=p(t.type,n,i,o):t=Object.assign(t,p(t.type,n,i,o))}else Array.isArray(t.type)?(t=c(t,n,i,o)).type=t.type.map(function(e){return p(e,n,i,o)}):"object"===a(t.type)?(t=c(t,n,i,o)).type=p(t.type,n,i,o):t=Object.assign(t,p(t.type,n,i,o));return null!=t.facets&&r.each(t.facets,function(e,r){t.facets[r]=p(e,n,i,o)}),t}function c(e,r,t,n){return void 0!==e.properties&&(e=f(e,r,t,n)),void 0!==e.anyOf&&(e=s(e,r,t,n)),void 0!==e.items&&(e=y(e,r,t,n)),e}function y(e,r,t,n){return e.items=p(e.items||"any",r,t,n),e}function f(e,r,t,n){var i=e.properties;for(var o in i)if(Object.prototype.hasOwnProperty.call(i,o)){var a=p(i[o]||"any",r,t,n);o.endsWith("?")&&(delete i[o],o=o.slice(0,-1),a.required=!1),void 0===a.required&&(a.required=!0),i[o]=a}return void 0===e.additionalProperties&&(e.additionalProperties=!0),e}function s(e,r,t,n){return e.anyOf=e.anyOf.map(function(e){return p(e,r,t,n)}),e}module.exports.expandedForm=function(r,t,n){var i={};"object"===a(n)&&(n=(i=n).callback);var o={};for(var e in t)if(t[e]===r){o[e]=!0;break}if(null==n)return p(r,t,o,i);setTimeout(function(){var e;try{e=p(r,t,o,i)}catch(e){return void n(e,null)}n(null,e)},0)};var t=Object.freeze({}),l=require("lodash"),d=require("./minType"),m=require("./util").consistencyCheck,b=require("./util").isOpaqueType;function v(p,r){var e=(p=l.cloneDeep(p)).type;if(b(e))return m(p);if("array"===e)return p.items=v(p.items||{type:"any"},r),m(p);if("object"===e){var t=p.properties,c=[l.cloneDeep(p)];if(c[0].properties={},l.each(t,function(e,o){var a=v(e,r);if("union"===a.type&&!1!==r.hoistUnions){var u=[];a.anyOf.forEach(function(e){"boolean"==typeof p.required&&(e.required=a.required);for(var r=0,t=c;r<t.length;r++){var n=t[r];n=l.cloneDeep(n);var i=Object.assign({},a,e);delete i.anyOf,n.properties[o]=i,u.push(n)}}),c=u}else c=c.map(function(e){return e.properties[o]=a,e})}),1===c.length)return m(c[0]);if(1<c.length)return p.type="union",delete p.properties,delete p.additionalProperties,p.anyOf=c,m(p)}else{if("union"===e)return p.anyOf=p.anyOf.map(function(e){return v("type"in e?e:{type:e},r)}),m(p);if("object"===a(e)){var n=function r(e){if(void 0!==e.properties)return"object";if(void 0!==e.items)return"array";if("string"==typeof e.type)return e.type;if("object"===a(e.type)){if(!Array.isArray(e.type))return r(e.type);var t=e.type.map(function(e){try{return r(e)}catch(e){return null}}).filter(function(e){return null!==e})[0];if(void 0!==t)return t}throw new Error("Cannot find top level class for node, not in expanded form")}(p),i=l.cloneDeep(p);switch(i.type=n){case"object":i.properties=i.properties||{};break;case"array":i.items=i.items||{type:"any"};break;case"union":i.anyOf=i.anyOf||[]}if(Array.isArray(e))return i=l.cloneDeep(e).map(function(e){return v(e,r)}).reduce(function(e,r){return d(r,e)},v(i,r));var o=v(e,r);return d(o,v(i,r))}}return p}module.exports.canonicalForm=function(r,t){var n={};if("object"===a(t)&&(t=(n=t).callback),null==t)return v(r,n);setTimeout(function(){var e;try{e=v(r,n)}catch(e){return void t(e,null)}t(null,e)},0)};var n=Object.freeze({}),i={expandedForm:t.expandedForm,canonicalForm:n.canonicalForm},o=i.expandedForm,O=i.canonicalForm;return e.canonicalForm=O,e.default=i,e.expandedForm=o,e}({});
//# sourceMappingURL=datatype-expansion.js.map
